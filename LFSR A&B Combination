#include <stdio.h>
#include <stdint.h>

typedef uint16_t u16;

// ===============================
//   SNOW-Vi POLYNOMIALS
// ===============================
//
// gA(x) = x^16 + x^14 + x^11 + x^9 + x^6 + x^5 + x^3 + x^2 + 1
// gB(x) = x^16 + x^15 + x^14 + x^11 + x^10 + x^7 + x^2 + x + 1
//
#define A_POLY  0x4A6D   // g_A(x)
#define B_POLY  0xCC87   // g_B(x)

// ===============================
//   STATE ARRAYS
// ===============================
u16 A[16];   // LFSR-A: a0 ... a15
u16 B[16];   // LFSR-B: b0 ... b15

// ===============================
//   MULTIPLICATION BY x
// ===============================
u16 mul_x(u16 v, u16 poly)
{
    if (v & 0x8000)
        return (v << 1) ^ poly;
    else
        return (v << 1);
}

// ===============================
//   ONE SNOW-Vi COMBINED STEP
// ===============================
//
//  a(t+16) = b(t) + α*a(t) + a(t+7)
//  b(t+16) = a(t) + β*b(t) + b(t+8)
//
// ===============================
void lfsr_step(void)
{
    u16 a0 = A[0];
    u16 a7 = A[7];

    u16 b0 = B[0];
    u16 b8 = B[8];

    // --- Compute feedbacks ---
    u16 newA = b0 ^ mul_x(a0, A_POLY) ^ a7;
    u16 newB = a0 ^ mul_x(b0, B_POLY) ^ b8;

    // --- Shift A ---
    for (int i = 0; i < 15; i++)
        A[i] = A[i + 1];
    A[15] = newA;

    // --- Shift B ---
    for (int i = 0; i < 15; i++)
        B[i] = B[i + 1];
    B[15] = newB;
}

// ===============================
//   PRINT FUNCTIONS
// ===============================
void print_state_A(void)
{
    printf("LFSR-A State (a15 ... a0):\n");
    for (int i = 15; i >= 0; i--)
        printf("%04x%s", A[i], (i % 4 == 0) ? "\n" : " | ");
}

void print_state_B(void)
{
    printf("LFSR-B State (b15 ... b0):\n");
    for (int i = 15; i >= 0; i--)
        printf("%04x%s", B[i], (i % 4 == 0) ? "\n" : " | ");
}
// ===============================
//   MAIN
// ===============================
int main(void)
{
    unsigned int w;

    printf("--- SNOW-Vi Combined LFSR-A + LFSR-B Simulation ---\n\n");

    // ------------------------------------------------------------
    // Initialize LFSR-A
    // a15 ... a8  <- Key k7 ... k0
    // a7  ... a0  <- IV  iv7 ... iv0
    // ------------------------------------------------------------
    printf("Enter 8 Key words (k7 ... k0) for LFSR-A:\n");
    for (int i = 15; i >= 8; i--) {
        if (scanf("%x", &w) != 1) return 1;
        A[i] = (u16)w;
    }

    printf("Enter 8 IV words (iv7 ... iv0) for LFSR-A:\n");
    for (int i = 7; i >= 0; i--) {
        if (scanf("%x", &w) != 1) return 1;
        A[i] = (u16)w;
    }

    // ------------------------------------------------------------
    // Initialize LFSR-B
    // b15 ... b8  <- Key k15 ... k8
    // b7  ... b0  <- 0
    // ------------------------------------------------------------
    printf("Enter 8 Key words (k15 ... k8) for LFSR-B:\n");
    for (int i = 15; i >= 8; i--) {
        if (scanf("%x", &w) != 1) return 1;
        B[i] = (u16)w;
    }

    printf("Setting (b7 ... b0) = 0\n");
    for (int i = 0; i <= 7; i++)
        B[i] = 0;

    // ------------------------------------------------------------
    // Print Initial State
    // ------------------------------------------------------------
    printf("\nInitial State:\n");
    print_state_A();
    print_state_B();

    // ------------------------------------------------------------
    // Run 16 SNOW-Vi combined steps
    // ------------------------------------------------------------
    printf("\nGenerating 16 SNOW-Vi combined updates:\n");
    for (int t = 0; t < 16; t++) {
        lfsr_step();
        printf("Step %2d: A15 = %04x | B15 = %04x\n",
               t + 1, A[15], B[15]);
    }

    // ------------------------------------------------------------
    // Final State
    // ------------------------------------------------------------
    printf("\nFinal LFSR-A State:\n");
    print_state_A();

    printf("\nFinal LFSR-B State:\n");
    print_state_B();

    return 0;
}
